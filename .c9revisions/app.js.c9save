{"ts":1386560830382,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"\n/**\n * Module dependencies.\n */\n\nvar express = require('express')\n  , routes = require('./routes')\n  , user = require('./routes/user')\n  , http = require('http')\n  , path = require('path')\n  , _ = require('underscore')\n  , MongoStore = require('connect-mongo')(express)\n  , async = require('async')\n  , jade_browser = require('jade-browser')\n  , moment = require('moment')\n_.str = require('underscore.string');\n\nvar cms = require('./lib/cms');\n\ncms.add('website_administration',{\n\tsingle:true,\n\tfields:{\n\t\tgoogle_analytics:{type:'string', multi:true},\n\t\tlogo:{type:'image', maintain_ratio:false,  crop_height:150, crop_width:240, sizes:[{prefix:\"medium\", width:240, height:180,}, {prefix:\"mediumbig\", width:370, height:370}]}\t\t\n\t}\n});\ncms.add('home_infopics',{\n\t\n\tfields:{\n\t\tname:{type:'string'},\n\t\tdescription:{type:'string', multi:true},\n\t\timage:{type:'image', maintain_ratio:false,  crop_height:150, crop_width:240, sizes:[{prefix:\"medium\", width:240, height:180,}, {prefix:\"mediumbig\", width:370, height:370}]}\t\t\n\t}\n});\ncms.add('jobs_page',{\n\tsingle:true,\n\tfields:{\n\t\theading:{type:'string'},\n\t\tdescription:{type:'string'},\n\t\timage:{type:'image', maintain_ratio:false, crop_width:940, crop_height:285},\n\t\tparagraphone_heading:{type:'string'},\n\t\tparagraphone_details:{type:'string', multi:true},\n\t\tparagraphtwo_heading:{type:'string'},\n\t\tparagraphtwo_details:{type:'string', multi:true},\n\t}\n});\ncms.add('jobs_posts',{\t\n\tfields:{\n\t\tname:{type:'string'},\n\t\tdescription:{type:'string', multi:true, rtl:true},\n\t\timage:{type:'image', maintain_ratio:false,  crop_height:230, crop_width:370, sizes:[{prefix:\"medium\", width:240, height:180,}, {prefix:\"mediumbig\", width:370, height:370}]},\n\t\texpiry:{type:'string', datepicker:true},\n\t\tdocuments:{type:'string'}\n\t}\n});\ncms.add('company_contacts',{\n\tfields:{\n\t\tname:{type:'string'},\n\t\tdescription:{type:'string'},\n\t\taddress1:{type:'string'},\n\t\taddress2:{type:'string'},\n\t\tcity:{type:'string'},\n\t\tphone:{type:'string'},\n\t\tfax:{type:'string'},\n\t\temail:{type:'string'},\n\t\twebsite:{type:'string'}\n\t}\n});\ncms.add('company_press', {\n\tfields:{\n\t\tname:{type:'string'},\n\t\tbrief:{type:'string', multi:true},\n\t\tarticle:{type:'string', multi:true, rtl:true},\n\t\timage:{type:'image', maintain_ratio:false,  crop_height:350, crop_width:700}\n\t}\n});\ncms.add('company_information', {\n\tfields:{\n\t\tname:{type:'string'},\n\t\tdetails:{type:'string', multi:true, rtl:true},\n\t}\n});\ncms.add('services_categories',{\n\tfields:{\n\t\tname:{type:'string'},\n\t\tdescription:{type:'string', multi:true},\n\t\tdownload:{type:'file'}\n\t}\n});\ncms.add('services_services',{\n\tfields:{\n\t\tname:{type:'string'},\n\t\tdescription:{type:'string', multi:true},\n\t\timage:{type:'image', maintain_ratio:false,  crop_height:280, crop_width:330},\n\t}\n});\ncms.add('sales_categories', {\n\tsearchable:true,\n\tfields:{\n\t\tname:{type:'string'},\n\t\tdetails:{type:'string', multi:true}\n\t}\n});\ncms.add('sales_products', {\n\tsearchable:true,\n\tfields:{\n\t\tname:{type:'string'},\n\t\tcategory:{type:'string', source:'sales_categories.name', autocomplete:true},\n\t\timage:{type:'image', maintain_ratio:false,  crop_height:270, crop_width:270},\n\t\tpictures:{type:'images', maintain_ratio:false,  crop_width:530, crop_height:270},\n\t\tdescription:{type:'string', multi:true},\n\t\tdetails:{type:'string', multi:true, rtl:true},\n\t\tprice:{type:'string'}\n\t}\n});\ncms.add('services_packages',{\n\tsearchable:true,\n\tfields:{\n\t\tname:{type:'string'},\n\t\tcategory:{type:'string', source:'services_categories.name', autocomplete:true},\n\t\tdescription:{type:'string', multi:true},\n\t\tdetails:{type:'string', multi:true, rtl:true},\n\t\tprice:{type:'string'},\n\t\tdownload_speed:{type:'string'},\n\t\tupload_speed:{type:'string'},\n\t\timage:{type:'image', maintain_ratio:false,  crop_height:230, crop_width:530},\n\t\tcolor:{type:'string', colorpicker:true},\n\t\tfeatured_on_homepage:{type:'boolean'},\n\t\tdownload:{type:'file'},\n\t\t\n\t}\n});\ncms.add('services_FAQCategory',{\n\tsearchable:true,\n\tfields:{\n\t\tname:{type:'string'}\n\t}\n});\ncms.add('services_faq',{\n\tsearchable:true,\n\tfields:{\n\t\tname:{type:'string'},\n\t\tcategory:{type:'string', source:'services_FAQCategory.name', autocomplete:true},\n\t\tanswer:{type:'string', multi:true, rtl:true}\n\t\t\n\t}\n});\ncms.add('company_management',{\n\tsearchable:true,\n\tfields:{\n\t\tname:{type:'string'},\n\t\tposition:{type:'string'},\n\t\tdetails:{type:'string', multi:true},\n\t\timage:{type:'image', maintain_ratio:false,  crop_height:215, crop_width:215}\t\t\n\t}\n});\ncms.add('company_affiliates',{\n\tsearchable:true,\n\tfields:{\n\t\tname:{type:'string'},\n\t\timage:{type:'image', maintain_ratio:true}\t\t\n\t}\n});\n\nvar app = express();\n\n// all environments\napp.set('port', process.env.PORT || 3099);\napp.set('views', __dirname + '/views');\napp.set('view engine', 'jade');\napp.use(express.favicon());\napp.use(express.logger('dev'));\napp.use(express.compress());\napp.use(express.cookieParser(\"herro\"));\napp.use(express.json());\napp.use(express.urlencoded());\n//app.use(connect.multipart());\napp.use(express.session({secret:\"herro\",store: new MongoStore({url:'mongodb://127.0.0.1:27017/rol'}), cookie: { maxAge: 600000000 ,httpOnly: false, secure: false}}));\napp.use(express.methodOverride());\napp.use(jade_browser('/modals/packages.js', 'package*', {root: __dirname + '/views/modals', cache:false}));\t\napp.use(jade_browser('/modals/products.js', 'product*', {root: __dirname + '/views/modals', cache:false}));\t\napp.use(jade_browser('/templates.js', '**', {root: __dirname + '/views/components', cache:false}));\t\napp.use(function(req, res, next){\n  \tres.header('Vary', 'Accept');\n\tnext();\n});\t\napp.use(app.router);\napp.use(express.static(path.join(__dirname, 'public')));\n\ncms.listen(app);\n\n\n// development only\nif ('development' == app.get('env')) {\n  app.use(express.errorHandler());\n}\n\napp.get('/', function(req, res){\n\tasync.auto({\n\t\tinfopics:function(fn){\n\t\t\tcms\n\t\t\t.home_infopics\n\t\t\t.find()\n\t\t\t.limit(4)\n\t\t\t.lean()\n\t\t\t.exec(fn);\n\t\t}\n\t}, \n\tfunction(err, page){\n\t\tif(err) throw err;\n\t\tres.render('index', page);\n\t});\n});\napp.get('/company-info', function(req,res){\n\tres.render('company-info');\n});\napp.get('/contact', function(req,res){\n\tasync.auto({\n\t\tfaq:function(fn){\n\t\t\tcms\n\t\t\t.services_faq\n\t\t\t.find()\n\t\t\t.lean()\n\t\t\t.exec(fn);\n\t\t}\n\t}, \n\tfunction(err, page){\n\t\tif(err) throw err;\n\t\tfor(var i=0; i<page.faq.length; i++){\n\t\t\tvar item = page.faq[i];\n\t\t\titem.title = _.str.slugify(item.name) + \"-\" + item._id;\n\t\t}\n\t\tres.render('contact', page);\n\t});\t\n});\napp.get('/jobs', function(req,res){\n\tasync.auto({\n\t\tpage:function(fn){\n\t\t\tcms\n\t\t\t.jobs_page\n\t\t\t.findOne()\n\t\t\t.lean()\n\t\t\t.exec(fn);\n\t\t},\n\t\tposts:function(fn){\n\t\t\tcms\n\t\t\t.jobs_posts\n\t\t\t.find()\n\t\t\t.lean()\n\t\t\t.exec(fn);\n\t\t}\n\t}, \n\tfunction(err, page){\n\t\tif(err) throw err;\n\t\tres.render('jobs', page);\n\t});\n});\napp.get('/press', function(req,res){\n\tpress(req,res);\n});\napp.get('/press/:article', function(req,res){\n\tpress(req,res,req.params.article);\n});\napp.get('/login', function(req,res){\n\tres.render('login');\n});\napp.post('/login', function(req,res){\n\tres.render('login',{login:true, used:\"15MB\", allowance:\"25GB\"});\n});\napp.get('/packages', function(req,res){\n\tpackages(req, res);\n});\napp.get('/services', function(req,res){\n\tcms.services_services.find({}, function(err, services){\n\t\tres.render('services', {services:services});\n\t})\n});\n\napp.get('/packages/:package', function(req,res){\n\tpackages(req, res, req.params.package);\n});\napp.get('/packages/:package/:product', function(req,res){\n\tpackages(req, res, req.params.package, \"/packages/\" + req.params.package + \"/\" + req.params.product);\n});\napp.get('/products', function(req, res){\n\tproducts(req, res);\n});\napp.get('/products/:category', function(req, res){\n\tproducts(req, res, req.params.category);\n});\napp.get('/products/:category/:product', function(req, res){\n\tvar product = req.params.product;\n\tproducts(req, res, req.params.category, product);\n});\napp.get('/rol', function(req, res){\n\tasync.auto({\n\t\tmanagement:function(fn){\n\t\t\tcms\n\t\t\t.company_management\n\t\t\t.find()\n\t\t\t.lean()\n\t\t\t.exec(fn);\n\t\t},\n\t\taffiliates:function(fn){\n\t\t\tcms\n\t\t\t.company_affiliates\n\t\t\t.find()\n\t\t\t.lean()\n\t\t\t.exec(fn);\n\t\t},\n\t\tpress:function(fn){\n\t\t\tcms.company_press\n\t\t\t.find()\n\t\t\t.sort({_id:-1})\n\t\t\t//.lean() /* if lean is used it wont give ObjectId's timestamp */\n\t\t\t.exec(function(err, docs){\n\t\t\t\tif(err) throw err;\n\t\t\t\tfor(var i=0; i<docs.length; i++){\n\t\t\t\t\tdocs[i].url = \"/press/\" + _.str.slugify(docs[i].name);\n\t\t\t\t\tdocs[i].slug = _.str.slugify(docs[i].name);\n\t\t\t\t\tdocs[i].date = moment(docs[i]._id.getTimestamp()).format(\"DD/MM/YYYY\");\n\t\t\t\t}\n\t\t\t\tvar times = _.groupBy(docs,function(e){\n\t\t\t\t\tvar x = moment(e._id.getTimestamp()); \n\t\t\t\t\tvar d = x.format('MMMM YYYY'); \n\t\t\t\t\treturn d; \n\t\t\t\t});\n\t\t\t\tfn(null,times);\n\t\t\t});\n\t\t},\n\t\tinfo:function(fn){\t\n\t\t\tcms\n\t\t\t.company_information\n\t\t\t.find()\n\t\t\t.lean()\n\t\t\t.exec(fn);\n\t\t}\n\t\t\n\t}, function(err, rol){\n\t\tres.render('aboutus', rol);\n\t});\n})\nfunction products(req, res, category, product){\n\tif(product){\n\t\tproduct = product.split(\"-\");\n\t\tproduct.pop();\n\t\tproduct = product.join(\"-\");\n\t}\n\tasync.auto({\n\t\tproducts:function(fn){\n\t\t\tcms\n\t\t\t.sales_products\n\t\t\t.find()\n\t\t\t.sort({_id:1})\n\t\t\t.lean()\n\t\t\t.exec(fn);\n\t\t}\n\t}, function(err, products){\n\t\tvar selected_product\n\t\t ,  selected_product_parent;\n\t\t    \n\t\tfor(var i=0; i<products.products.length; i++){\n\t\t\tvar slug_cat = _.str.slugify(products.products[i].category);\n\t\t\tvar slug_prod = _.str.slugify(products.products[i].name);\n\t\t\tproducts.products[i].slug = slug_prod;\n\t\t\tproducts.products[i].slug_cat = slug_cat;\n\t\t\tproducts.products[i].url = \"/products/\" + slug_cat + \"/\" + slug_prod + \"-\" + products.products[i]._id;\n\t\t\tproducts.products[i].selected = true;\n\t\t\tif(category && category != slug_cat){\n\t\t\t\tproducts.products[i].selected = false;\n\t\t\t}\n\t\t\tif(product && product == products.products[i].slug){\t\t\t\t\n\t\t\t\tselected_product = products.products[i].url;\n\t\t\t\tselected_product_parent = \"/products/\" + slug_cat;\n\t\t\t}\n\t\t}\n\t\t//categories\n\t\tproducts.categories = _.uniq(_.pluck(products.products,'category'));\n\t\tfor(var i=0; i<products.categories.length; i++){\n\t\t\tproducts.categories[i] = {\n\t\t\t\tname: products.categories[i],\n\t\t\t\tslug: _.str.slugify(products.categories[i]),\n\t\t\t\turl: '/products/' + _.str.slugify(products.categories[i])\n\t\t\t}\n\t\t\tif(category && category == products.categories[i].slug){\n\t\t\t\tproducts.categories[i].selected = true;\n\t\t\t}\n\t\t}\n\t\tif(category){\n\t\t\tproducts.selected = category;\n\t\t\tif(product){\n\t\t\t\tproducts.selected_product = selected_product;\n\t\t\t\tproducts.selected_product_parent = selected_product_parent;\n\t\t\t}\n\t\t}\n\t\tres.render('products', products);\n\t});\n\n}\nfunction press(req,res,article){\n\tvar sel;\n\tasync.auto({\n\t\tcontacts:function(fn){\n\t\t\tcms.company_contacts\n\t\t\t.find()\n\t\t\t.sort({_id:1})\n\t\t\t.lean()\n\t\t\t.exec(fn);\n\t\t},\n\t\tpress:function(fn){\n\t\t\tcms.company_press\n\t\t\t.find()\n\t\t\t.sort({_id:-1})\n\t\t\t//.lean() /* if lean is used it wont give ObjectId's timestamp */\n\t\t\t.exec(function(err, docs){\n\t\t\t\tif(err) throw err;\n\t\t\t\tfor(var i=0; i<docs.length; i++){\n\t\t\t\t\tdocs[i].url = \"/press/\" + _.str.slugify(docs[i].name);\n\t\t\t\t\tdocs[i].slug = _.str.slugify(docs[i].name);\n\t\t\t\t\tdocs[i].date = moment(docs[i]._id.getTimestamp()).format(\"DD/MM/YYYY\");\n\t\t\t\t\tif(article == docs[i].slug){\n\t\t\t\t\t\tsel = docs[i];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tvar times = _.groupBy(docs,function(e){\n\t\t\t\t\tvar x = moment(e._id.getTimestamp()); \n\t\t\t\t\tvar d = x.format('MMMM YYYY'); \n\t\t\t\t\treturn d; \n\t\t\t\t});\n\t\t\t\tfn(null,times);\n\t\t\t});\n\t\t}\n\t}, function(err, page){\n\t\tif(article){\n\t\t\tpage.select = sel;\n\t\t}\n\t\tres.render('press', page);\n\t});\n\n}\nfunction packages(req,res,select, product){\n\tasync.auto({\n\t\tnavigation:function(fn){\n\t\t\tcms\n\t\t\t.services_categories\n\t\t\t.find()\n\t\t\t.lean()\n\t\t\t.exec(function(err, docs){\n\t\t\t\tif(err) throw err;\n\t\t\t\tvar nav;\n\t\t\t\tif(select)\n\t\t\t\t\tnav = generateURL(docs, \"name\", \"packages\", select);\n\t\t\t\telse\n\t\t\t\t\tnav = generateURL(docs, \"name\", \"packages\");\n\t\t\t\tfn(err, nav);\n\t\t\t});\n\t\t},\n\t\tcategories:function(fn){\n\t\t\tcms\n\t\t\t.services_categories\n\t\t\t.find()\n\t\t\t.lean()\n\t\t\t.exec(fn);\n\t\t},\n\t\tpackages:function(fn){\n\t\t\tcms\n\t\t\t.services_packages\n\t\t\t.find()\n\t\t\t.lean()\n\t\t\t.exec(function(err, packages){\n\t\t\t\tvar packages = _.map(packages, function(p){\n\t\t\t\t\tp.url = \"/packages/\" + _.str.slugify(p.category) + \"/\" + _.str.slugify(p.name);\n\t\t\t\t\treturn p;\n\t\t\t\t});\n\t\t\t\tfn(err, packages);\n\t\t\t});\n\t\t}\n\t}, function(err, page){\n\t\tvar packages_grp = _.groupBy(page.packages,'category');\n\t\tvar categories_grp = _.groupBy(page.categories, 'name');\n\t\tvar packages = [];\n\t\tfor(var p in packages_grp){\n\t\t\tvar obj = {\n\t\t\t\tname:p, \n\t\t\t\tdescription:categories_grp[p][0].description, \n\t\t\t\tpackages:packages_grp[p]\n\t\t\t};\n\t\t\tif(select){\n\t\t\t\tif(select == _.str.slugify(p)){\n\t\t\t\t\tobj.active = true;\n\t\t\t\t}else{\n\t\t\t\t\tobj.active = false;\n\t\t\t\t}\n\t\t\t}else{\n\t\t\t\tobj.active = true;\n\t\t\t}\n\t\t\tpackages.push(obj);\t\t\n\t\t}\n\n\t\tpage.packages = packages;\n\t\tif(product){\n\t\t\tpage.product = product;\n\t\t\tvar parent = product.split(\"/\");\n\t\t\tparent.pop();\n\t\t\tpage.product_parent = parent.join(\"/\");\n\t\t}\n\t\tres.render('packages', page);\n\t});\n\n}\n\nfunction generateURL(urls, key, append, select){\n\tvar append = append ? \"/\" + append + \"/\":'';\n\treturn _.map(urls, function(d){\n\t\tvar obj = {\n\t\t\ttext:d[key], \n\t\t\turl:append + _.str.slugify(d[key]),\n\t\t\tslug:_.str.slugify(d[key])\n\t\t}\n\t\tif(select && obj.slug == select){\n\t\t\tobj.active = true;\n\t\t}\n\t\treturn obj;\n\t});\n}\nhttp.createServer(app).listen(app.get('port'), function(){\n  console.log('Express server listening on port ' + app.get('port'));\n});\n"]],"start1":0,"start2":0,"length1":0,"length2":13339}]],"length":13339}
